{{template "game" .}}

{{define "card-table"}}
    <div id="bidding" class="shadow">
        <form>
            <h5>Pick your bid</h5>
            <div id="bid-buttons"></div>
        </form>
    </div>

    <div id="calling" class="shadow">
        <form>
            <h5>Pick your trump</h5>
            <div id="trump-buttons"></div>
        </form>
    </div>

    <div id="bids">
    <div id="bid-0" class="other-bid shadow" style="left:309px; top:303px; display:none;"></div>      
    <div id="bid-1" class="other-bid shadow" style="left:98px; top:173px; display:none;"></div> 
    <div id="bid-2" class="other-bid shadow" style="left:327px; top:120px; display:none;"></div>
    <div id="bid-3" class="other-bid shadow" style="left:559px; top:173px; display:none;"></div>
    </div>

    <div id="name-0" class="name-plate" style="left:696px; top:393px; display:none;"></div>
    <div id="name-1" class="name-plate" style="left:18px; top:281px; display:none;"></div>
    <div id="name-2" class="name-plate" style="left:438px; top:24px; display:none;"></div>
    <div id="name-3" class="name-plate" style="left:696px; top:281px; display:none;"></div>

    <div id="info-0" class="info-plate" style="left:707px; top:415px;"><ul></ul></div>
    <div id="info-1" class="info-plate" style="left:31px; top:300px;"><ul></ul></div>
    <div id="info-2" class="info-plate" style="left:449px; top:44px;"><ul></ul></div>
    <div id="info-3" class="info-plate" style="left:707px; top:300px;"><ul></ul></div>

    <div id="trump"></div>
    <div id="no-trump">No Trump</div>

    <div id="last-trick" class="shadow">
        Last trick
        <div id="trick-tally" style="position:absolute; right:2px; top:2px;">
            Trick tally
            <table>
            <thead>
            <tr>
                <th id="trick-tally-02-names"></th>
                <th id="trick-tally-13-names"></th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td id="trick-tally-02-tally"></td>
                <td id="trick-tally-13-tally"></td>
            </tr>
            </tbody>
            </table>    
        </div>
        <div style="position:absolute; right:2px; bottom:2px;">
            <small>
                <span style="color:red;">Red</span> is card led.
                <span style="color:blue;">Blue</span> is winner.
            </small>
        </div>
    </div>

    <div id="score" class="shadow">
        Score
        <table>
        <thead>
        <tr>
            <th id="score-02-names"></th>
            <th id="score-13-names"></th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td id="score-02-score"></td>
            <td id="score-13-score"></td>
        </tr>
        </tbody>
        </table>
        <div id="show-score-details" style="position:absolute; bottom:2px; right:2px;">
            <a href="#" onclick="$('#score-detail').show(); return false;"><small>Details</small></a>
        </div>    
    </div>

    <div id="score-detail" class="shadow">
        Score
        <table>
        <thead>
        <tr>
            <th id="score-detail-02-names"></th>
            <th id="score-detail-13-names"></th>
        </tr>
        </thead>
        <tbody id="score-detail-scores"></tbody>
        </table>
        <div id="hide-score-details" style="position:absolute; top:2px; right:2px;"><a href="#" onclick="$('#score-detail').hide(); return false;">Close</a></div>    
    </div>

{{end}}


{{define "scripts"}}
<script src="/static/scripts/kaiser.js"></script>
<script>
    var id = "{{.ID}}";
    server.init();

    // Show a stack of cards in the middle of the table to make it look like a card game.
    var table = "#card-table";
    cards.init({
        table:table, 
        cardsUrl:"/static/images/cards.png",     
    }); 
    var deck = new cards.Deck();
    deck.addCards(cards.all);
    deck.render({immediate:true});

    function repaint(gameState) {
        $("#trump").hide();
        $("#no-trump").hide();
        switch (gameState.State) {
            case "BIDDING":
                repaintBidding(gameState);
                break;
            case "CALLING":
                repaintCalling(gameState);
                break;
            case "PLAYING":
                repaintPlaying(gameState);
                break;
            case "COMPLETED":
                repaintCompleted(gameState);
                break;
            default:
                console.log("Unknown state '" + s + "'");
        }
        showScore(gameState);
    }

    function repaintCards(gameState) {
        $(".player-card").remove();
        let playerCards = [];
        if (gameState.PlayerHand) {
            let left = 150 + ((8 - gameState.PlayerHand.length) * 32);
            gameState.PlayerHand.forEach((serverCard, i) => {
                let c = makeCard(serverCard);
                c.setPosition(left + (i * 71), 440);
                c.makeVisible();
                $(c.el).addClass("player-card");
                playerCards.push(c);
            });
        }

        let stackPositions = [
            [50, 220],
            [390, 60],
            [730, 220]
        ];

        stackPositions.forEach(function(stack, i) {
            for (let i = 0; i < 8; i++) {
                let c = makeOpponentCard();
                c.setPosition(stack[0] + i, stack[1] + i);
                c.scale(.7);
                c.hideCard();
                c.makeVisible();
            }
        });

        gameState.PlayerNames.forEach((name, i) => {
            let rot = rotate(gameState, i);
            $("#name-" + rot).text(shortName(name)).show();
        });

        return playerCards;
    }

    function showBids(gameState) {
        let bidsPlaced = gameState.BidsPlaced;
        let leadBidPosition = gameState.LeadBidPosition;

        if (!bidsPlaced) {
            return;
        }
        bidsPlaced.forEach((bid, i) => {
            let rot = rotate(gameState, leadBidPosition + i);
            $("#bid-" + rot).text(shortNoTrump(bid.Human)).show();
        });
    }

    function showInfos(gameState) {
        let dealerPosition = gameState.DealerPosition;
        let positionToPlay = gameState.PositionToPlay;
        let winningBid = gameState.WinningBid;
        let winningBidPosition = gameState.WinningBidPosition;

        $(".info-item").remove();
        let rot = rotate(gameState, dealerPosition);
        $("#info-"+rot+ " ul").append($("<li/>").addClass("info-item").text("Dealer"));

        if (winningBid) {
            rot = rotate(gameState, winningBidPosition);
            $("#info-"+rot+ " ul").append($("<li/>").addClass("info-item").text("Bid " + winningBid.Human));
        }

        rot = rotate(gameState, positionToPlay);
        $("#info-"+rot+ " ul").append($("<li/>").addClass("info-item").text("To play"));
    }

    function showCurrentTrick(gameState) {
        let trick = gameState.Trick;
        let trickLeadPosition = gameState.TrickLeadPosition;
        let lastTrick = gameState.LastTrick;
        let lastTrickLeadPosition = gameState.LastTrickLeadPosition;
        let lastTrickWinningPosition = gameState.LastTrickWinningPosition;
        let bidsPlaced = gameState.BidsPlaced;
        let cardPosition = [
            [393, 295],
            [309, 225],
            [393, 150],
            [475, 225]
        ];

        showCurrent = function() {
            $(".trick-card").remove();
            if (trick) {
                trick.forEach((card, i) => {
                    let rot = rotate(gameState, trickLeadPosition + i);
                    let c = makeCard(card);
                    c.setPosition(cardPosition[rot][0], cardPosition[rot][1]);
                    $(c.el).addClass("trick-card");
                    if (i==0) {
                        $(c.el).addClass("lead-card");
                    }
                    c.makeVisible();
                });
            }
        }

        // if no current trick and there is a last trick, then show last trick for N seconds before proceeding.
        if (lastTrick && !trick && !bidsPlaced) {
            $(".trick-card").remove();
            let winningRot = rotate(gameState, lastTrickWinningPosition);
            lastTrick.forEach((card, i) => {
                let rot = rotate(gameState, lastTrickLeadPosition + i);
                let c = makeCard(card);
                c.setPosition(cardPosition[rot][0], cardPosition[rot][1]);
                $(c.el).addClass("trick-card");
                if (i==0) {
                    $(c.el).addClass("lead-card");
                }
                if (rot==winningRot) {
                    $(c.el).removeClass("lead-card");
                    $(c.el).addClass("winning-card");
                }
                c.makeVisible();
            });
            setTimeout(showCurrent, 3000);
        } else {
            showCurrent();
        }
    }

    function showLastTrick(gameState) {
        let lastTrick = gameState.LastTrick;
        let lastTrickLeadPosition = gameState.LastTrickLeadPosition;
        let lastTrickWinningPosition = gameState.LastTrickWinningPosition;
        let trickTally = gameState.TrickTally;

        $(".last-trick-card").remove();
        if (!lastTrick) {
            $("#last-trick").hide();
            return
        }

        $("#last-trick").show();

        let cardPosition = [
            [90, 100],
            [40, 70],
            [90, 42],
            [140, 70]
        ];

        let winningRot = rotate(gameState, lastTrickWinningPosition);
        lastTrick.forEach((card, i) => {
            let rot = rotate(gameState, lastTrickLeadPosition + i);
            let c = makeCard(card);
            c.setPosition(cardPosition[rot][0], cardPosition[rot][1]);
            c.scale(.6);
            $(c.el).addClass("last-trick-card");
            if (i==0) {
                $(c.el).addClass("lead-card");
            }
            if (rot==winningRot) {
                $(c.el).removeClass("lead-card");
                $(c.el).addClass("winning-card");
            }
            c.makeVisible();
        });

        // Add trick counts
        $("#trick-tally-02-names").html(team02(gameState));
        $("#trick-tally-13-names").html(team13(gameState));
        if (trickTally) {
            $("#trick-tally-02-tally").text(trickTally[0]);
            $("#trick-tally-13-tally").text(trickTally[1]);
        }
    }

    function showScore(gameState) {
        let t02 = team02(gameState);
        let t13 = team13(gameState);
        $("#score-02-names").html(t02);
        $("#score-13-names").html(t13);
        $("#score-detail-02-names").html(t02);
        $("#score-detail-13-names").html(t13);

        $("#score-02-score").text(gameState.CurrentScore[0]);
        $("#score-13-score").text(gameState.CurrentScore[1]);

        $("#score-detail-scores").empty();
        if (gameState.Score) {
            gameState.Score.forEach((hand) => {
                let tr = $("<tr/>");
                tr.append($("<td/>").text(hand[0]));
                tr.append($("<td/>").text(hand[1]));
                $("#score-detail-scores").append(tr);
            });
        }
    }

    function repaintBidding(gameState) {
        $(".trick-card").remove();
        $("#bidding").hide();
        $("#bids").show();
        // Turn off all panels that show bids.
        for (let pos = 0; pos < 4; pos++) {
                 $("#bid-" + pos).removeClass("to-bid").hide();
        }

        // Show bids that have been placed.
        showBids(gameState);
        showInfos(gameState);
        repaintCards(gameState);

        // Show bidding panel when your turn to bid.
        if(gameState.PlayerPosition == gameState.PositionToPlay){
            $("#bid-buttons").empty();
            if(gameState.AvailableBids != null) {
                gameState.AvailableBids.forEach((bid) => {
                    $("#bid-buttons").append(
                        $("<button/>").val(bid.Code).text(shortNoTrump(bid.Human)).click(() => { 
                            $("#bid-buttons button").prop("disabled", true);
                            server.placeBid(id, bid.Code, (gameState) => {
                                repaint(gameState);
                            });
                        })
                    );
                });
            }
            $("#bidding").show();
        } else {
            // Show the player making a bid.
            let rot = rotate(gameState, gameState.PositionToPlay);
            $("#bid-" + rot).text("Bidding").addClass("to-bid").show();
        }

        showCurrentTrick(gameState);
        showLastTrick(gameState);
    }

    function repaintCalling(gameState) {
        $("#bidding").hide();
        $("#bids").show();
        showBids(gameState);
        showInfos(gameState);
        repaintCards(gameState);

        // Update bidding card to show winning bid.
        let rot = rotate(gameState, gameState.PositionToPlay);
        $("#bid-" + rot).html(gameState.WinningBid.Human + "<br><small>(Calling trump)</small>").addClass("calling");

        let trumps = [
            ["H", suitHuman("H")],
            ["S", suitHuman("S")],
            ["D", suitHuman("D")],
            ["C", suitHuman("C")]
        ];

        $("#trump-buttons").empty();
        trumps.forEach((trump) => {
            $("#trump-buttons").append(
                $("<button/>").val(trump[0]).html(trump[1]).click(() => { 
                    $("#trump-buttons button").prop("disabled", true);
                    server.callTrump(id, trump[0], (gameState) => {
                        $(".other-bid .calling").removeClass("calling");
                        repaint(gameState);
                    });
                })
            );
        });

        if (gameState.PlayerPosition == gameState.PositionToPlay) {
            $("#bid-0").hide();
            $("#calling").show();
            $("#calling h5").text("Pick your trump (your bid: " + gameState.WinningBid.Human + ")");
        }

        showLastTrick(gameState);
    }

    function repaintPlaying(gameState) {
        $("#bidding").hide();
        $("#calling").hide();
        $("#bids").hide();

        if (gameState.Trump == "N") {
            $("#trump").hide();
            $("#no-trump").show();
        } else {
            $("#trump").html(suitHuman(gameState.Trump)).show();
            $("#no-trump").hide();
        }

        showInfos(gameState);
        let playerCards = repaintCards(gameState);

        // Add event handlers to cards.
        playerCards.forEach((card) => {
            $(card.el)
            .hover(
                (event) => {
                    $(event.target).animate({top: "350px"}, "fast");
                }, 
                (event) => {
                    $(event.target).animate({top: "392px"}, "fast");
                })
            .click(
                (event) => {
                    if (gameState.PositionToPlay != gameState.PlayerPosition) {
                        alert("Not your turn!");
                        return;
                    }
                    // Disable card clicks.
                    $(".player-card").click(()=>{});

                    // TODO: animate card to center

                    server.playCard(id, makeServerCard(card), (gameState) => {
                        repaint(gameState);
                    });
                });
        });

        showCurrentTrick(gameState);
        showLastTrick(gameState);
    }

    function repaintCompleted(gameState) {
        // TODO
    }

    function makeCard(serverCard) {
        let rankStr = serverCard.substr(0, 1);
        let rank = 0;
        switch(rankStr) {
            case "A":
                rank = 1;
                break;
            case "K":
                rank = 13;
                break;
            case "Q":
                rank = 12;
                break;
            case "J":
                rank = 11;
                break;
            case "T":
                rank = 10;
                break;
            default:
                rank = parseInt(rankStr, 10);
        }
        let suit = serverCard.substr(1, 1).toLowerCase();
        return new cards.Card(suit, rank, table);
    }

    function makeServerCard(card) {
        let suit = card.suit.toUpperCase();
        let rank = card.rank;
        switch (card.rank) {
            case 1:
            case 14:
                rank = "A";
                break;
            case 13:
                rank = "K";
                break;
            case 12:
                rank = "Q";
                break;
            case 11:
                rank = "J";
                break;
            case 10:
                rank = "T";
                break;
        }
        return "" + rank + suit;
    }

    function makeOpponentCard() {
        return new cards.Card('rj', 0, table);
    }

    function rotate(gameState, pos) {
        // Returns the rotated position, such that the local player is index 0.
        return (pos - gameState.PlayerPosition + 4) % 4;
    }

    function suitHuman(suit) {
        switch (suit) {
            case "H":
                return "<span style='color:red;'>&hearts;</span>";
            case "S": 
                return "&spades;";
            case "D":
                return "<span style='color:red;'>&diams;</span>";
            case "C":
                return "&clubs;";
            default:
                return "No Trump";
        }
    }

    function shortNoTrump(label) {
        if (!label.endsWith(" Trump")) {
            return label;
        }
        return label.substr(0, label.length - " Trump".length)
    }

    function team02(gameState) {
        return shortName(gameState.PlayerNames[0])+"<br>"+shortName(gameState.PlayerNames[2])
    }

    function team13(gameState) {
        return shortName(gameState.PlayerNames[1])+"<br>"+shortName(gameState.PlayerNames[3])
    }

    function shortName(name) {
        if (!name) {
            return name;
        }
        return name.substr(0, 10);
    }

    kaiser.init(id, {repaint: repaint}); // This starts polling and updating the game board.

</script>
{{end}}
