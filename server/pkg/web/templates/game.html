{{template "game" .}}

{{define "card-table"}}
    <div id="bidding" class="shadow">
        <form>
            <h5>Pick your bid</h5>
            <div id="bid-buttons"></div>
        </form>
    </div>

    <div id="calling" class="shadow">
        <form>
            <h5>Pick your trump</h5>
            <div id="trump-buttons"></div>
        </form>
    </div>

    <div id="called" class="shadow" style="display:none;">
        <h5></h5>
    </div>

    <div id="bids">
    <div id="bid-0" class="other-bid shadow" style="left:327px; top:303px; display:none;"></div>
    <div id="bid-1" class="other-bid shadow" style="left:98px; top:207px; display:none;"></div>
    <div id="bid-2" class="other-bid shadow" style="left:327px; top:126px; display:none;"></div>
    <div id="bid-3" class="other-bid shadow" style="left:559px; top:207px; display:none;"></div>
    </div>

    <div id="passed">
    <div id="passed-0" class="other-bid shadow" style="left:300px; top:303px; width: 196px; display:none;">Pass a card!</div>
    <div id="passed-1" class="other-bid shadow" style="left:98px; top:207px; display:none;">Passing</div>
    <div id="passed-2" class="other-bid shadow" style="left:327px; top:126px; display:none;">Passing</div>
    <div id="passed-3" class="other-bid shadow" style="left:559px; top:207px; display:none;">Passing</div>
    </div>

    <div id="name-0" class="name-plate" style="left:696px; top:393px; display:none;"></div>
    <div id="name-1" class="name-plate" style="left:18px; top:281px; display:none;"></div>
    <div id="name-2" class="name-plate" style="left:438px; top:24px; display:none;"></div>
    <div id="name-3" class="name-plate" style="left:696px; top:281px; display:none;"></div>

    <div id="info-0" class="info-plate" style="left:707px; top:415px;"><ul></ul></div>
    <div id="info-1" class="info-plate" style="left:31px; top:300px;"><ul></ul></div>
    <div id="info-2" class="info-plate" style="left:449px; top:44px;"><ul></ul></div>
    <div id="info-3" class="info-plate" style="left:707px; top:300px;"><ul></ul></div>

    <div id="trump"></div>
    <div id="no-trump">No Trump</div>

    <div id="last-trick" class="shadow">
        Last trick
        <div id="trick-tally" style="position:absolute; right:2px; top:2px;">
            Trick tally
            <table>
            <thead>
            <tr>
                <th id="trick-tally-02-names"></th>
                <th id="trick-tally-13-names"></th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td id="trick-tally-02-tally"></td>
                <td id="trick-tally-13-tally"></td>
            </tr>
            </tbody>
            </table>    
        </div>
        <div style="position:absolute; right:2px; bottom:2px;">
            <small>
                <span style="color:red;">Red</span> was led.
                <span style="color:blue;">Blue</span> was winner.
            </small>
        </div>
    </div>

    <div id="score" class="shadow">
        Score
        <table>
        <thead>
        <tr>
            <th id="score-02-names"></th>
            <th id="score-13-names"></th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td id="score-02-score"></td>
            <td id="score-13-score"></td>
        </tr>
        </tbody>
        </table>
        <div style="position:absolute; bottom:2px; left:2px;">
            <small class="show-score-towin"></small>
        </div>    
        <div id="show-score-details" style="position:absolute; bottom:2px; right:2px;">
            <a href="#" onclick="$('#score-detail').show(); return false;"><small>Details</small></a>
        </div>    
    </div>

    <div id="score-detail" class="shadow">
        Score
        <table>
        <thead>
        <tr>
            <th id="score-detail-02-names" colspan="2"></th>
            <th id="score-detail-13-names" colspan="2"></th>
        </tr>
        </thead>
        <tbody id="score-detail-scores"></tbody>
        </table>
        <div style="position:absolute; bottom:2px; left:2px;">
            <small class="show-score-towin"></small>
        </div>    
        <div id="hide-score-details" style="position:absolute; top:2px; right:2px;"><a href="#" onclick="$('#score-detail').hide(); return false;">Close</a></div>    
    </div>

{{end}}


{{define "scripts"}}
<script src="/static/scripts/kaiser.js"></script>
<script>
    var id = "{{.ID}}";
    server.init();

    let table = "#card-table";
    cards.init({
        table: table 
    }); 

    let cardPosition = [
        [359, 273],
        [279, 195],
        [359, 132],
        [438, 195]
    ];

    let cardHash = (state, card) => hash(id + (state.Score? state.Score.length: 0) + card);
    let cardLeft = (rot, hash) => cardPosition[rot][0] + (hash%10)-5;
    let cardTop = (rot, hash) => cardPosition[rot][1] + (hash%10)-5;
    let cardAngle = (rot, hash) => (hash%16)-8;

    function repaint(gameState) {
        $("#trump").hide();
        $("#no-trump").hide();
        switch (gameState.State) {
            case "PASSING":
                repaintPassing(gameState);
                break;
            case "BIDDING":
                repaintBidding(gameState);
                break;
            case "CALLING":
                repaintCalling(gameState);
                break;
            case "PLAYING":
                repaintPlaying(gameState);
                break;
            case "COMPLETED":
                repaintCompleted(gameState);
                break;
            default:
                console.log("Unknown state '" + s + "'");
        }
        showScore(gameState);
    }

    function repaintCards(gameState) {
        $(".player-card").remove();
        let playerCards = [];
        if (gameState.PlayerHand) {
            let left = 115 + ((8 - gameState.PlayerHand.length) * 32);
            gameState.PlayerHand.forEach((card, i) => {
                let c = new cards.Card(card, left + (i * 71), 395);
                $(c.el).addClass("player-card");
                if (gameState.CardReceived == card) {
                    $(c.el).addClass("card-received");
                }
                c.makeVisible();
                playerCards.push(c);
            });
        }

        let stackPositions = [
            [0, 0],
            [13, 175],
            [353, 15],
            [693, 175]
        ];

        $(".opponent-card").remove();
        for (let stack = 1; stack < 4; stack++) {
            let rot = (gameState.PlayerPosition + stack + 4) % 4;
            for (let i = 0; i < gameState.HandCounts[rot]; i++) {
                let c = new cards.Card('JOK', stackPositions[stack][0] + (i*2), stackPositions[stack][1] + (i*2));
                $(c.el).addClass("opponent-card");
                c.scale(.9);
                c.hideCard();
                c.makeVisible();
            }
        }

        gameState.PlayerNames.forEach((name, i) => {
            let rot = rotate(gameState, i);
            $("#name-" + rot).text(shortName(name)).show();
        });

        return playerCards;
    }

    function showBids(gameState) {
        let bidsPlaced = gameState.BidsPlaced;
        let leadBidPosition = gameState.LeadBidPosition;

        if (!bidsPlaced) {
            return;
        }
        bidsPlaced.forEach((bid, i) => {
            let rot = rotate(gameState, leadBidPosition + i);
            $("#bid-" + rot).text(shortNoTrump(bid.Human)).show();
        });
    }

    function hideInfos(gameState) {
        $(".info-item").remove();
    }

    function showInfos(gameState) {
        let dealerPosition = gameState.DealerPosition;
        let positionToPlay = gameState.PositionToPlay;
        let winningBid = gameState.WinningBid;
        let winningBidPosition = gameState.WinningBidPosition;

        hideInfos(gameState);
        let rot = rotate(gameState, dealerPosition);
        $("#info-"+rot+ " ul").append($("<li/>").addClass("info-item").text("Dealer"));

        if (winningBid.Human && gameState.State != "CALLING" && gameState.State != "PASSING") {
            rot = rotate(gameState, winningBidPosition);
            let msg = "Bid " + winningBid.Human;
            if (gameState.Trump != "N") {
                msg += " " + suitHuman(gameState.Trump);
            }
            $("#info-"+rot+ " ul").append($("<li/>").addClass("info-item").html(msg));
        }

        rot = rotate(gameState, positionToPlay);
        let li = $("<li/>").addClass("info-item").addClass("to-play");
        if (positionToPlay == gameState.PlayerPosition) {
            li.addClass("your-turn").text("Your turn!");
        } else {
            li.text("To play");
        }
        $("#info-"+rot+ " ul").append(li);
    }

    function showCurrentTrick(gameState) {
        let trick = gameState.Trick;
        let trickLeadPosition = gameState.TrickLeadPosition;
        let lastTrick = gameState.LastTrick;
        let lastTrickLeadPosition = gameState.LastTrickLeadPosition;
        let lastTrickWinningPosition = gameState.LastTrickWinningPosition;
        let bidsPlaced = gameState.BidsPlaced;

        showCurrent = function(cardsToRemove) {
            $("."+cardsToRemove).remove();
            if (trick) {
                trick.forEach((card, i) => {
                    let rot = rotate(gameState, trickLeadPosition + i);
                    let h = cardHash(gameState, card);
                    let c = new cards.Card(card, cardLeft(rot, h), cardTop(rot, h));
                    c.rotate(cardAngle(rot, h));
                    $(c.el).addClass("trick-card");
                    if (i==0) {
                        $(c.el).addClass("lead-card");
                    }
                    c.makeVisible();
                });
            }
        }

        // if no current trick and there is a last trick, then show last trick for N seconds before proceeding.
        if (lastTrick && !trick && !bidsPlaced) {
            $(".trick-card").remove();
            let winningRot = rotate(gameState, lastTrickWinningPosition);
            lastTrick.forEach((card, i) => {
                let rot = rotate(gameState, lastTrickLeadPosition + i);
                let h = cardHash(gameState, card);
                let c = new cards.Card(card, cardLeft(rot, h), cardTop(rot, h));
                c.rotate(cardAngle(rot, h));
                $(c.el).addClass("trick-card");
                // Add an alternate class name so that we can remove these cards specifically after the timeout.
                $(c.el).addClass("trick-card-delay");
                if (i==0) {
                    $(c.el).addClass("lead-card");
                }
                if (rot==winningRot) {
                    $(c.el).removeClass("lead-card");
                    $(c.el).addClass("winning-card");
                }
                c.makeVisible();
            });
            setTimeout(() => showCurrent("trick-card-delay"), 3000);
        } else {
            showCurrent("trick-card");
        }
    }

    function showLastTrick(gameState) {
        let lastTrick = gameState.LastTrick;
        let lastTrickLeadPosition = gameState.LastTrickLeadPosition;
        let lastTrickWinningPosition = gameState.LastTrickWinningPosition;
        let trickTally = gameState.TrickTally;

        $(".last-trick-card").remove();
        if (!lastTrick) {
            $("#last-trick").hide();
            return
        }

        $("#last-trick").show();

        let lastTrickcardPosition = [
            [58, 59],
            [6, 23],
            [58, -3],
            [107, 23]
        ];

        let winningRot = rotate(gameState, lastTrickWinningPosition);
        lastTrick.forEach((card, i) => {
            let rot = rotate(gameState, lastTrickLeadPosition + i);
            let c = new cards.Card(card, lastTrickcardPosition[rot][0], lastTrickcardPosition[rot][1]);
            c.scale(.6);
            $(c.el).addClass("last-trick-card");
            if (i==0) {
                $(c.el).addClass("lead-card");
            }
            if (rot==winningRot) {
                $(c.el).removeClass("lead-card");
                $(c.el).addClass("winning-card");
            }
            c.makeVisible();
        });

        // Add trick counts
        $("#trick-tally-02-names").html(team02(gameState));
        $("#trick-tally-13-names").html(team13(gameState));
        if (trickTally) {
            $("#trick-tally-02-tally").text(trickTally[0]);
            $("#trick-tally-13-tally").text(trickTally[1]);
        }
    }

    function showScore(gameState) {
        let t02 = team02(gameState);
        let t13 = team13(gameState);
        $("#score-02-names").html(t02);
        $("#score-13-names").html(t13);
        $("#score-detail-02-names").html(t02);
        $("#score-detail-13-names").html(t13);

        if (gameState.State == "COMPLETED") {
            let winner = $("#score-detail-02-names");
            let loser = $("#score-detail-13-names");
            if (gameState.WinningTeam == 1) {
                winner = $("#score-detail-13-names");
                loser = $("#score-detail-02-names");
            }
            winner.html("<div class='winner'>WINNER!<br>" + winner.html() + "</div>");
            loser.html("<br>" + loser.html());
        }

        $("#score-02-score").text(gameState.CurrentScore[0]);
        $("#score-13-score").text(gameState.CurrentScore[1]);

        $("#score-detail-scores").empty();
        if (gameState.Score) {
            gameState.Score.forEach((entry) => {
                let tr = $("<tr/>");
                tr.append($("<td/>").text(entry.Score02));
                tr.append($("<td/>").addClass("score-note").text(entry.Note02));
                tr.append($("<td/>").text(entry.Score13));
                tr.append($("<td/>").addClass("score-note").text(entry.Note13));
                $("#score-detail-scores").append(tr);
            });
        }

        $(".show-score-towin").text("" + gameState.ToWin + " to win");
    }

    function repaintPassing(gameState) {
        $(".trick-card").remove();
        $("#bidding").hide();
        $("#bids").show();
        hideInfos(gameState);
        // Turn off all panels that show bids.
        for (let pos = 0; pos < 4; pos++) {
                 $("#bid-" + pos).removeClass("to-bid").hide();
        }
        // Turn off the passing panels.
        for (let i = 0; i < 4; i++) {
            $("#passed-"+i).hide();
        }
        $("#passed").show();

        // For each passed card, show it face down in front of the player.
        $(".passed-card").remove();
        let cardPassed = false;
        gameState.CardsPassed.forEach((isPassed, i) => {
            if (!isPassed) {
                return;
            }
            cardPassed = true;
            let rot = rotate(gameState, gameState.LeadPassPosition + i);
            let h = cardHash(gameState, "" + i);
            let c = new cards.Card('JOK', cardLeft(rot, h), cardTop(rot, h));
            c.rotate(cardAngle(rot, h));
            $(c.el).addClass("passed-card");
            c.hideCard(); // face down
            c.makeVisible();
        });

        // Show the player to play's card.
        let rot = rotate(gameState, gameState.PositionToPlay);
        $("#passed-"+rot).show();

        // Add event handlers to cards.
        let playerCards = repaintCards(gameState);
        playerCards.forEach((card) => {
            $(card.el)
            .hover(
                (event) => {
                    $(event.target).animate({top: "380px"}, "fast");
                }, 
                (event) => {
                    $(event.target).animate({top: "395px"}, "fast");
                })
            .click(
                (event) => {
                    event.preventDefault();
                    if (gameState.PositionToPlay != gameState.PlayerPosition) {
                        alert("Not your turn!");
                        return;
                    }
                    // Disable card clicks.
                    $(".player-card").click((event)=>{event.preventDefault();});

                    server.passCard(id, card.code, (gameState) => {
                        repaint(gameState);
                    });
                });
        });

        if (!cardPassed) {
            showCurrentTrick(gameState);
        }
        showLastTrick(gameState);
    }

    function repaintBidding(gameState) {
        $(".trick-card").remove();
        $("#bidding").hide();
        $("#bids").show();
        $("#passed").hide();
        $(".passed-card").remove();
        // Turn off all panels that show bids.
        for (let pos = 0; pos < 4; pos++) {
                 $("#bid-" + pos).removeClass("to-bid").hide();
        }

        // Show bids that have been placed.
        showBids(gameState);
        showInfos(gameState);
        repaintCards(gameState);

        // Show bidding panel when your turn to bid.
        if(gameState.PlayerPosition == gameState.PositionToPlay){
            $("#bid-buttons").empty();
            if(gameState.AvailableBids != null) {
                gameState.AvailableBids.forEach((bid) => {
                    $("#bid-buttons").append(
                        $("<button/>").val(bid.Code).text(shortNoTrump(bid.Human)).click((event) => {
                            event.preventDefault(); 
                            $("#bid-buttons button").prop("disabled", true);
                            server.placeBid(id, bid.Code, (gameState) => {
                                repaint(gameState);
                            });
                        })
                    );
                });
            }
            $("#bidding").show();
        } else {
            // Show the player making a bid.
            let rot = rotate(gameState, gameState.PositionToPlay);
            $("#bid-" + rot).text("Bidding").addClass("to-bid").show();
        }

        if (!gameState.Rules.PassCard) {
            showCurrentTrick(gameState);
        }
        showLastTrick(gameState);
    }

    function repaintCalling(gameState) {
        $("#bidding").hide();
        $("#bids").show();
        $("#passed").hide();
        showBids(gameState);
        showInfos(gameState);
        repaintCards(gameState);

        // Update bidding card to show winning bid.
        let rot = rotate(gameState, gameState.PositionToPlay);
        $("#bid-" + rot).html(gameState.WinningBid.Human + "<br><small>(Calling trump)</small>").addClass("calling");

        let trumps = [
            ["H", suitHuman("H")],
            ["S", suitHuman("S")],
            ["D", suitHuman("D")],
            ["C", suitHuman("C")]
        ];

        $("#trump-buttons").empty();
        trumps.forEach((trump) => {
            $("#trump-buttons").append(
                $("<button/>").val(trump[0]).html(trump[1]).click((event) => { 
                    event.preventDefault();
                    $("#trump-buttons button").prop("disabled", true);
                    server.callTrump(id, trump[0], (gameState) => {
                        $(".other-bid .calling").removeClass("calling");
                        repaint(gameState);
                    });
                })
            );
        });

        if (gameState.PlayerPosition == gameState.PositionToPlay) {
            $("#bid-0").hide();
            $("#calling").show();
            $("#calling h5").text("Pick your trump (your bid: " + gameState.WinningBid.Human + ")");
        }

        showLastTrick(gameState);
    }

    function repaintPlaying(gameState) {
        $("#bidding").hide();
        $("#calling").hide();
        $("#bids").hide();
        $("#passed").hide();

        // Special case: if playing, no cards played and player hand has 8 cards, then show what was bid.
        let justCalled = false;
        if (!gameState.Trick && gameState.PlayerHand.length == 8) {
            justCalled = true;
            $(".trick-card").remove();
            $("#called h5").html(suitHuman(gameState.Trump) + " called!");
            let elem = $("#called");
            elem.show();
            setTimeout(() => elem.hide(), 3000);
        }

        if (gameState.Trump == "N") {
            $("#trump").hide();
            $("#no-trump").show();
        } else {
            $("#trump").html(suitHuman(gameState.Trump)).show();
            $("#no-trump").hide();
        }

        showInfos(gameState);
        let playerCards = repaintCards(gameState);

        // Add event handlers to cards.
        playerCards.forEach((card) => {
            $(card.el)
            .hover(
                (event) => {
                    $(event.target).animate({top: "380px"}, "fast");
                }, 
                (event) => {
                    $(event.target).animate({top: "395px"}, "fast");
                })
            .click(
                (event) => {
                    event.preventDefault();
                    if (gameState.PositionToPlay != gameState.PlayerPosition) {
                        alert("Not your turn!");
                        return;
                    }
                    // Disable card clicks.
                    $(".player-card").click((event)=>{event.preventDefault();});

                    server.playCard(id, card.code, (gameState) => {
                        repaint(gameState);
                    });
                });
        });

        if (!justCalled) {
            showCurrentTrick(gameState);
        }
        showLastTrick(gameState);
    }

    function repaintCompleted(gameState) {
        $("#bidding").hide();
        $("#calling").hide();
        $("#bids").hide();
        showLastTrick(gameState);
        showScore(gameState);
        showScoreDetail(gameState);
    }

    function showScoreDetail(gameState) {
        $("#score-detail").show();

        $("#hide-score-details").empty();
        $("#hide-score-details").append($("<a>", {href : "/", text: "Play again"}));
        let elem = $("#score-detail tbody");
        elem.scrollTop(2000000);
    }

    function rotate(gameState, pos) {
        // Returns the rotated position, such that the local player is index 0.
        return (pos - gameState.PlayerPosition + 4) % 4;
    }

    function suitHuman(suit) {
        switch (suit) {
            case "H":
                return "<span style='color:red;'>&hearts;</span>";
            case "S": 
                return "&spades;";
            case "D":
                return "<span style='color:red;'>&diams;</span>";
            case "C":
                return "&clubs;";
            default:
                return "No Trump";
        }
    }

    function shortNoTrump(label) {
        if (!label.endsWith(" No Trump")) {
            return label;
        }
        return label.substr(0, label.length - " No Trump".length) + "No"
    }

    function team02(gameState) {
        return shortName(gameState.PlayerNames[0])+"<br>"+shortName(gameState.PlayerNames[2])
    }

    function team13(gameState) {
        return shortName(gameState.PlayerNames[1])+"<br>"+shortName(gameState.PlayerNames[3])
    }

    function shortName(name) {
        if (!name) {
            return name;
        }
        return name.substr(0, 10);
    }

    function hash(s) {
        var h = 0;
        if (!s) {
            return h;
        }
        for (let i = 0; i < s.length; i++) {
            let ch = s.charCodeAt(i);
            h = ((h<<5)-h)+ch;
            h = h & h;
        }
        return Math.abs(h);
    }

    kaiser.init(id, {repaint: repaint}); // This starts polling and updating the game board.

</script>
{{end}}
